<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Chatbot</title>

    <!-- Bootstrap 4 -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <!-- Custom Dark Theme CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body class="dark-theme">

<div class="container-fluid h-100 d-flex flex-column chat-container">
    <div class="card shadow-lg flex-fill d-flex flex-column">
        <!-- Header -->
        <div class="card-header text-white text-center py-4 header-gradient">
            <h3 class="mb-1"><i class="fas fa-robot mr-2"></i>PDF Chatbot</h3>
            <p class="mb-0 opacity-75">Upload any PDF and ask questions about its content</p>
        </div>

        <!-- Messages Area -->
        <div id="messageArea" class="card-body msg_card_body flex-fill p-4">
            <!-- Welcome Message (shown initially) -->
            <div class="text-center text-muted py-5 welcome-message">
                <i class="fas fa-file-pdf fa-4x mb-4 text-primary"></i>
                <h5>Welcome to PDF Chatbot!</h5>
                <p class="lead">Upload a PDF document below to start asking questions about its content.</p>
            </div>
        </div>

        <!-- Footer: Upload + Chat Input -->
        <div class="card-footer p-4 footer-bg">
            <!-- Upload Section -->
            <div id="uploadSection">
                <form id="uploadForm" enctype="multipart/form-data">
                    <div class="input-group input-group-lg">
                        <div class="custom-file">
                            <input type="file" class="custom-file-input" id="pdfFile" accept=".pdf" required>
                            <label class="custom-file-label text-light" for="pdfFile">Choose PDF file...</label>
                        </div>
                        <div class="input-group-append">
                            <button class="btn btn-upload" type="submit">
                                <i class="fas fa-upload mr-2"></i>Upload PDF
                            </button>
                        </div>
                    </div>
                </form>
                <div id="uploadStatus" class="mt-3 text-center"></div>
            </div>

            <!-- Chat Section (hidden until PDF uploaded) -->
            <div id="chatSection" style="display: none;">
                <form id="chatForm" class="input-group input-group-lg mb-3">
                    <input type="text" id="userInput" placeholder="Ask a question about the PDF..." 
                           class="form-control input-dark" autocomplete="off" required>
                    <div class="input-group-append">
                        <button type="submit" class="btn btn-send">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </form>

                <!-- New PDF / Clear Chat Button -->
                <div class="text-center">
                    <button id="newPdfBtn" class="btn btn-outline-light btn-sm px-4">
                        <i class="fas fa-file-pdf mr-2"></i>New PDF / Clear Chat
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
// Function to add a message to the chat
function addMessage(text, type = 'bot') {
    const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
    let messageHTML;

    if (type === 'user') {
        messageHTML = `
            <div class="d-flex justify-content-end mb-4">
                <div class="msg_cotainer_send">
                    ${text}
                    <span class="msg_time_send">${time}</span>
                </div>
                <div class="img_cont_msg">
                    <img src="https://i.ibb.co/d5b84Xw/Untitled-design.png" class="rounded-circle user_img_msg">
                </div>
            </div>`;
    } else {
        messageHTML = `
            <div class="d-flex justify-content-start mb-4">
                <div class="img_cont_msg">
                    <img src="https://cdn-icons-png.flaticon.com/512/387/387569.png" class="rounded-circle user_img_msg">
                </div>
                <div class="msg_cotainer">
                    ${text}
                    <span class="msg_time">${time}</span>
                </div>
            </div>`;
    }

    $("#messageArea").append(messageHTML);
    $("#messageArea").scrollTop($("#messageArea")[0].scrollHeight);
}

// Update file input label
$('#pdfFile').on('change', function() {
    const filename = this.files[0]?.name || "Choose PDF file...";
    $(this).next('.custom-file-label').html(filename);
});

// Handle PDF Upload
$('#uploadForm').on('submit', function(e) {
    e.preventDefault();
    const file = $('#pdfFile')[0].files[0];
    if (!file) return;

    const formData = new FormData();
    formData.append('file', file);

    $('#uploadStatus').html('<small class="text-info"><i class="fas fa-spinner fa-spin mr-2"></i>Processing PDF... This may take a moment.</small>');

    $.ajax({
        url: '/upload',
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function(data) {
            $('#uploadStatus').html(`<small class="text-success"><i class="fas fa-check-circle mr-2"></i>${data.message}</small>`);
            $('#uploadSection').slideUp(400);
            $('#chatSection').slideDown(600);
            $('#messageArea').empty();
            addMessage(`ðŸ“„ <strong>${data.filename}</strong> has been successfully loaded!<br>Ask me anything about its content.`, 'bot');
            $('#userInput').focus();
        },
        error: function(xhr) {
            const err = xhr.responseJSON?.error || "Upload failed. Please try again.";
            $('#uploadStatus').html(`<small class="text-danger"><i class="fas fa-exclamation-triangle mr-2"></i>${err}</small>`);
        }
    });
});

// Handle Sending Messages
$('#chatForm').on('submit', function(e) {
    e.preventDefault();
    const msg = $('#userInput').val().trim();
    if (!msg) return;

    addMessage(msg, 'user');
    $('#userInput').val('');

    // Optional: Show typing indicator
    addMessage('<i class="fas fa-spinner fa-spin"></i> Thinking...', 'bot');

    $.post('/get', { msg: msg }, function(data) {
        // Remove typing indicator
        $('#messageArea .msg_cotainer:last').parent().remove();
        addMessage(data.response, 'bot');
    }).fail(function() {
        $('#messageArea .msg_cotainer:last').parent().remove();
        addMessage("Sorry, I couldn't process your question. Please try again.", 'bot');
    });
});

// New PDF / Clear Chat Button
$('#newPdfBtn').on('click', function() {
    $('#chatSection').slideUp(400);
    $('#uploadSection').slideDown(600);
    $('#uploadStatus').empty();
    $('#pdfFile').val('');
    $('.custom-file-label').html('Choose PDF file...');

    $('#messageArea').empty();
    $('#messageArea').html(`
        <div class="text-center text-muted py-5 welcome-message">
            <i class="fas fa-file-pdf fa-4x mb-4 text-primary"></i>
            <h5>Welcome to PDF Chatbot!</h5>
            <p class="lead">Upload a PDF document below to start asking questions about its content.</p>
        </div>
    `);

    // Clear session on backend
    $.post('/clear');
});
</script>

</body>
</html>